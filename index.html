<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOX STELLARUM</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // –î–æ—Å—Ç–∞–µ–º –∏–∫–æ–Ω–∫–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ lucide
        const { Sparkles, Moon, Sun, Scroll, RefreshCw, Wand2, Quote } = {
            Sparkles: (props) => <i data-lucide="sparkles" {...props}></i>,
            Moon: (props) => <i data-lucide="moon" {...props}></i>,
            RefreshCw: (props) => <i data-lucide="refresh-cw" {...props}></i>,
            Wand2: (props) => <i data-lucide="wand-2" {...props}></i>,
            Quote: (props) => <i data-lucide="quote" {...props}></i>
        };

        const TAROT_DECK = [
            { name: "The Fool", emoji: "üÉè" }, { name: "The Magician", emoji: "ü™Ñ" },
            { name: "The High Priestess", emoji: "üåô" }, { name: "The Empress", emoji: "üåø" },
            { name: "The Emperor", emoji: "üëë" }, { name: "The Hierophant", emoji: "‚õ™" },
            { name: "The Lovers", emoji: "‚ù§Ô∏è" }, { name: "The Chariot", emoji: "‚öîÔ∏è" },
            { name: "Strength", emoji: "ü¶Å" }, { name: "The Hermit", emoji: "üèÆ" },
            { name: "Wheel of Fortune", emoji: "üé°" }, { name: "Justice", emoji: "‚öñÔ∏è" },
            { name: "The Hanged Man", emoji: "‚è≥" }, { name: "Death", emoji: "üíÄ" },
            { name: "Temperance", emoji: "üç∑" }, { name: "The Devil", emoji: "üòà" },
            { name: "The Tower", emoji: "‚ö°" }, { name: "The Star", emoji: "‚≠ê" },
            { name: "The Moon", emoji: "üåï" }, { name: "The Sun", emoji: "‚òÄÔ∏è" },
            { name: "Judgement", emoji: "üé∫" }, { name: "The World", emoji: "üåç" }
        ];

        const FormattedReading = ({ text }) => {
            if (!text) return null;
            const blocks = text.split('\n\n');
            return (
                <div className="space-y-6">
                    {blocks.map((block, idx) => {
                        const cleanBlock = block.replace(/[#*]/g, '').trim();
                        if (idx === 0) return <p key={idx} className="text-xl italic text-amber-200/90 text-center">{cleanBlock}</p>;
                        return <p key={idx} className="text-amber-100/80 leading-relaxed">{cleanBlock}</p>;
                    })}
                </div>
            );
        };

        const App = () => {
            const [step, setStep] = React.useState('welcome');
            const [selectedCards, setSelectedCards] = React.useState([]);
            const [reading, setReading] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const [question, setQuestion] = React.useState("");

            React.useEffect(() => { lucide.createIcons(); }, [step, loading]);

            const drawCard = (card) => {
                if (selectedCards.length < 3 && !selectedCards.find(c => c.name === card.name)) {
                    setSelectedCards([...selectedCards, card]);
                }
            };

            const generateReading = async () => {
                setLoading(true);
                setStep('reading');
                const cardNames = selectedCards.map(c => c.name).join(", ");
                
                try {
                    const response = await fetch("/api/oracle", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            question: `–ú–æ–π –≤–æ–ø—Ä–æ—Å: ${question}. –í—ã–ø–∞–≤—à–∏–µ –∫–∞—Ä—Ç—ã: ${cardNames}` 
                        })
                    });
                    const data = await response.json();
                    setReading(data.answer);
                } catch (err) {
                    setReading("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –º–∏—Ä–æ–º –¥—É—Ö–æ–≤.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-950 text-amber-100 p-6 font-serif">
                    <div className="max-w-3xl mx-auto py-12">
                        <header className="text-center mb-16">
                            <h1 className="text-5xl font-bold text-amber-400 mb-2">VOX STELLARUM</h1>
                            <p className="text-amber-600 tracking-widest uppercase text-xs">–ì–æ–ª–æ—Å –ó–≤–µ–∑–¥</p>
                        </header>

                        {step === 'welcome' && (
                            <div className="bg-slate-900/40 p-10 rounded-3xl border border-amber-900/30 text-center">
                                <textarea 
                                    className="w-full bg-transparent border-b border-amber-900/50 p-4 text-2xl outline-none mb-10"
                                    placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..."
                                    value={question}
                                    onChange={(e) => setQuestion(e.target.value)}
                                />
                                <button onClick={() => setStep('drawing')} className="w-full py-5 bg-amber-600 rounded-2xl text-slate-950 font-bold uppercase">–ù–∞—á–∞—Ç—å —Ä–∏—Ç—É–∞–ª</button>
                            </div>
                        )}

                        {step === 'drawing' && (
                            <div className="space-y-12">
                                <div className="grid grid-cols-3 gap-4">
                                    {[0, 1, 2].map(i => (
                                        <div key={i} className="aspect-[2/3] border-2 border-dashed border-amber-900/30 rounded-2xl flex items-center justify-center text-4xl bg-slate-900/50">
                                            {selectedCards[i] ? selectedCards[i].emoji : "‚ú¶"}
                                        </div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-6 gap-2">
                                    {TAROT_DECK.map((card, i) => (
                                        <button key={i} onClick={() => drawCard(card)} className="aspect-[2/3] bg-slate-900 border border-amber-900/40 rounded-lg hover:border-amber-400">‚úß</button>
                                    ))}
                                </div>
                                {selectedCards.length === 3 && (
                                    <button onClick={generateReading} className="w-full py-5 border-2 border-amber-500 text-amber-400 rounded-full font-bold uppercase">–£–∑–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É</button>
                                )}
                            </div>
                        )}

                        {step === 'reading' && (
                            <div className="bg-slate-900/60 p-10 rounded-3xl border border-amber-500/20">
                                {loading ? <p className="text-center animate-pulse">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –≠—Ñ–∏—Ä–æ–º...</p> : <FormattedReading text={reading} />}
                                {!loading && <button onClick={() => location.reload()} className="mt-10 block mx-auto text-amber-600 uppercase text-xs">–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora&display=swap');
        body { font-family: 'Lora', serif; }
        h1 { font-family: 'Cinzel', serif; }
    </style>
</body>
</html>
